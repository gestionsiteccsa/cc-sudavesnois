const cityData = {
    "Anor": {
        "ordures": "mercredi",
        "verre": {
            "jour": "mercredi",
            "dates": [
                "2025-01-08",
                "2025-02-05",
                "2025-03-05",
                "2025-04-09",
                "2025-05-07",
                "2025-06-04",
                "2025-07-09",
                "2025-08-06",
                "2025-09-03",
                "2025-10-08",
                "2025-11-05",
                "2025-12-03"
            ]
        }
    },
    "Baives": {
        "ordures": "lundi",
        "verre": {
            "jour": "lundi",
            "dates": [
                "2025-01-13",
                "2025-02-10",
                "2025-03-10",
                "2025-04-14",
                "2025-05-12",
                "2025-06-09",
                "2025-07-14",
                "2025-08-11",
                "2025-09-08",
                "2025-10-13",
                "2025-11-10",
                "2025-12-08"
            ]
        }
    },
    "Wallers-en-Fagne": {
        "ordures": "lundi",
        "verre": {
            "jour": "lundi",
            "dates": [
                "2025-01-13",
                "2025-02-10",
                "2025-03-10",
                "2025-04-14",
                "2025-05-12",
                "2025-06-09",
                "2025-07-14",
                "2025-08-11",
                "2025-09-08",
                "2025-10-13",
                "2025-11-10",
                "2025-12-08"
            ]
        }
    },
    "Moustier-en-Fagne": {
        "ordures": "lundi",
        "verre": {
            "jour": "lundi",
            "dates": [
                "2025-01-13",
                "2025-02-10",
                "2025-03-10",
                "2025-04-14",
                "2025-05-12",
                "2025-06-09",
                "2025-07-14",
                "2025-08-11",
                "2025-09-08",
                "2025-10-13",
                "2025-11-10",
                "2025-12-08"
            ]
        }
    },
    "Eppe-Sauvage": {
        "ordures": "lundi",
        "verre": {
            "jour": "lundi",
            "dates": [
                "2025-01-13",
                "2025-02-10",
                "2025-03-10",
                "2025-04-14",
                "2025-05-12",
                "2025-06-09",
                "2025-07-14",
                "2025-08-11",
                "2025-09-08",
                "2025-10-13",
                "2025-11-10",
                "2025-12-08"
            ]
        }
    },
    "Willies": {
        "ordures": "lundi",
        "verre": {
            "jour": "lundi",
            "dates": [
                "2025-01-13",
                "2025-02-10",
                "2025-03-10",
                "2025-04-14",
                "2025-05-12",
                "2025-06-09",
                "2025-07-14",
                "2025-08-11",
                "2025-09-08",
                "2025-10-13",
                "2025-11-10",
                "2025-12-08"
            ]
        }
    },
    "Féron": {
        "ordures": "jeudi",
        "verre": {
            "jeudi": [
                "2025-01-09",
                "2025-02-06",
                "2025-03-06",
                "2025-04-10",
                "2025-05-08",
                "2025-06-05",
                "2025-07-10",
                "2025-08-07",
                "2025-09-04",
                "2025-10-09",
                "2025-11-06",
                "2025-12-04"
            ]
        }
    },
    "Glageon": {
        "ordures": "mardi",
        "verre": {
            "jour": "mardi",
            "dates": [
                "2025-01-14",
                "2025-02-11",
                "2025-03-11",
                "2025-04-15",
                "2025-05-13",
                "2025-06-10",
                "2025-07-15",
                "2025-08-12",
                "2025-09-09",
                "2025-10-14",
                "2025-11-11",
                "2025-12-09"
            ]
        }
    },
    "Ohain": {
        "ordures": "jeudi",
        "verre": {
            "jour": "jeudi",
            "dates": [
                "2025-01-16",
                "2025-02-13",
                "2025-03-13",
                "2025-04-17",
                "2025-05-15",
                "2025-06-12",
                "2025-07-17",
                "2025-08-14",
                "2025-09-11",
                "2025-10-16",
                "2025-11-13",
                "2025-12-11"
            ]
        }
    },
    "Wignehies": {
        "ordures": "jeudi",
        "verre": {
            "jour": "jeudi",
            "dates": [
                "2025-01-09",
                "2025-02-06",
                "2025-03-06",
                "2025-04-10",
                "2025-05-08",
                "2025-06-05",
                "2025-07-10",
                "2025-08-07",
                "2025-09-04",
                "2025-10-09",
                "2025-11-06",
                "2025-12-04"
            ]
        }
    },
    "Fourmies": {
        "ordures": {
            "lundi": [
                "rue du 8 mai 1945",
                "rue aldred maton",
                "rue alphonse moreau",
                "square ampère",
                "rue anatole France",
                "impasse andré wannin",
                "rue andré wannin",
                "rue baligant",
                "residence bellevue",
                "chemin des blés",
                "rue du bois",
                "rue boris vian",
                "rue bouret",
                "avenue des bureaux",
                "rue des catelets",
                "rue des champs",
                "rue du chanoine thuliez",
                "rue des charbonniers",
                "rue charles petit",
                "rue du chauffour",
                "rue des cléments",
                "rue du conditionnement",
                "rue courtecuisse",
                "impasse curie",
                "rue curie",
                "rue danièle casanova",
                "rue delval",
                "impasse des écoles",
                "rue edouard verpraet",
                "rue de l'égalité",
                "rue des éliets",
                "rue de l'entrepot",
                "rue ernest thomas",
                "impasse des étangs",
                "rue des étangs",
                "impasse fauchart",
                "rue felix labourdette",
                "rue fernand pecheux",
                "impasse fossé des vœux",
                "rue gambetta",
                "rue de la gare",
                "rue du général gouttiére",
                "place georges coppeaux",
                "rue de grenoble",
                "rue guy môquet",
                "rue de l'hôpital",
                "rue des howis",
                "rue des jardins",
                "rue jean moulin",
                "rue jean baptiste lebas",
                "avenue joliot-curie",
                "impasse jules guesde",
                "rue jules guesdes",
                "résidence le clos sollier",
                "rue des lilas",
                "rue louis braille",
                "rue louise michel",
                "rue marcel ulrici",
                "impasse marchand",
                "impaase marcy",
                "rue marie-louise meyer",
                "rue marius eldert",
                "rue michel dubois",
                "rue ninite",
                "rue du nouveau monde",
                "cité nouvelle",
                "cité des oiseaux",
                "rue d'orient",
                "rue pasteur",
                "rue paul lafargue",
                "rue pilette",
                "résidence de la plaine à joncs",
                "rue de la plaine à joncs",
                "rue de la planchette",
                "avenue du président kennedy",
                "rue proisy",
                "rue raoul delvaux",
                "rue de la république",
                "rue de la république prolongée",
                "rue robespierre",
                "rue des rouets",
                "rue des rousseaux",
                "rue sencier",
                "rue thierry",
                "résidence des tilleuls",
                "rue sans pareille",
                "résidence de la vallée de l'helpe",
                "rue des verreries",
                "impasse verte"
            ],
            "mardi": [
                "Rue Alexandre Mulat",
                "place alfred derigny",
                "square allende",
                "Rue Alphonse Staincq",
                "rue antoine renaud",
                "avenue des astronautes",
                "rue d'avesnes",
                "rue basse du moulin",
                "rue de bernburg",
                "rue berthelot",
                "rue bleue",
                "rue branly",
                "rue de la brasserie",
                "place claude jourdain",
                "rue de la commune de paris",
                "rue de la concorde",
                "rue cousin corbier",
                "rue croizet-eliet",
                "impasse du défriché",
                "rue du défriché",
                "rue de douai",
                "quartier dury",
                "rue édouard flament",
                "rue de l'émaillerie",
                "rue émile zola",
                "rue de l'espérance",
                "residence de l'étang",
                "rue eugène paris",
                "rue faidherbe",
                "rue de la fontaine rouge",
                "rue françois delaplace",
                "rue de la fraternité",
                "rue gabriel zaya",
                "rue gaston torlet",
                "rue des glycines",
                "rue du gymnase",
                "rue des haies",
                "rue haute du moulin",
                "rue de l'helpe",
                "rue henri dunant",
                "rue de la houppe du bois",
                "rue jacques duclos",
                "impasse jean jaurès",
                "rue jean jaurès",
                "rue jean-pierre dupont",
                "rue jean pierre lenoble",
                "impasse jeanne d'arc",
                "rue de là-haut",
                "rue léo lagrange",
                "rue de la Liberté",
                "rue de lille",
                "rue du maire coppeaux",
                "cité droulers",
                "résidence le malakoff",
                "rue marceau batteux",
                "place maria blondeau",
                "avenue de la marliére",
                "rue de minonsars",
                "rue du moulin",
                "rue du nord",
                "rue de la paix",
                "impasse du paradis",
                "rue du paradis",
                "allée des renvideurs",
                "place de la republique",
                "avenue roger couderc",
                "boulevard sadi carnot",
                "rue serpentine",
                "rue théophile legrand",
                "rue traversiére",
                "rue des troenes",
                "rue de valenciennes",
                "rue du vallon",
                "place de verdun",
                "rue victor hugo",
                "rue xavier clavon",
            ],
            "mercredi": [
                "rue adolphe hugé",
                "rue d'anor",
                "rue de la cense",
                "rue de colnet",
                "rue du dachet",
                "rue du fief",
                "rue de la fontaine à l'tuerie",
                "rue des noires terres",
                "rue des pierres",
                "rue saint louis",
                "rue saint pierre",
                "rue saint pierre prolongée",
                "rue de la savonnerie",
                "rue du terne",
                "rue tranquille",
            ],
            "jeudi": [
                "residence bellevue",
                "rue de craonne",
                "quartier flament",
                "rue de la forge",
                "rue de fridley",
                "rue du général leclerc",
                "square jean mermoz",
                "rue de jeanne III",
                "rue de la lamberie",
                "rue du marais",
                "sqare saint exupery",
                "impasse du temple",
                "rue victor delloue",
                "Vieux Chemin de Wignehies",
                "Vieux Chemin de Fourmies",
            ],  
        },
        "verre": {
            "lundi": [
                "2025-01-06",
                "2025-02-03",
                "2025-03-03",
                "2025-04-07",
                "2025-05-05",
                "2025-06-02",
                "2025-07-07",
                "2025-08-04",
                "2025-09-01",
                "2025-10-06",
                "2025-11-03",
                "2025-12-01"
            ],
            "mardi": [
                "2025-01-07",
                "2025-02-04",
                "2025-03-04",
                "2025-04-08",
                "2025-05-06",
                "2025-06-03",
                "2025-07-08",
                "2025-08-05",
                "2025-09-02",
                "2025-10-07",
                "2025-11-04",
                "2025-12-02"
            ],
            "mercredi": [
                "2025-01-08",
                "2025-02-05",
                "2025-03-05",
                "2025-04-09",
                "2025-05-07",
                "2025-06-04",
                "2025-07-09",
                "2025-08-06",
                "2025-09-03",
                "2025-10-08",
                "2025-11-05",
                "2025-12-03"
            ],  
            "jeudi": [
                "2025-01-09",
                "2025-02-06",
                "2025-03-06",
                "2025-04-10",
                "2025-05-08",
                "2025-06-05",
                "2025-07-10",
                "2025-08-07",
                "2025-09-04",
                "2025-10-09",
                "2025-11-06",
                "2025-12-04"
            ]
        }
    },
    "Trélon": {
        "ordures": {
            "mercredi": [
                "Rue Victor Hugo",
                "Rue Aristide Briand",
                "Place du Maréchal Joffre",
                "Rue Delval",
                "Rue Emile Zola",
                "Rue des hirondelles",
                "Rue Neuve",
                "Rue Lobet",
                "rue des champs",
                "Rue Calmette",
                "Rue Guérin",
                "Rue du Maréchal Foch",
                "Rue Emile Zola",
                "Chemin des sars",
                "Moulin de la Carnaille",
                "rue des Glycines",
                "Rue Robert Fontesse",
                "Résidence de la pierre trouée",
                "rue des églantines",
                "rue de Bellevue",
                "Rue Ernest Dimnet",
                "Rue des lilas",
                "rue de l'espérance",
                "rue de l'étoile",
                "rue du champ d'asile",
                "rue du fourneau",
                "rue du pont seru",
                "rue de la liberté",
                "route de chimay",
                "rue de la coulonnière",
                "impasse pasteur",
                "rue heureuse",
                "impasse ramon",
                "rue du quartier du tissage",
                "rue du fourneau",
                "rue du gazomètre",
                "rue françois ansieau",
                "rue du petit marché",
                "rue guillaume deltour",
                "rue de la halle",
                "rue clavon collignon",
                "rue thiers",
                "rue gambetta",
                "rue andré daubercies",
                "rue escalier royal",
                "place léon comerre",
                "place de la piquerie",
                "chemin de la brasserie",
                "Rue du Maréchal Foch",
                "rue du belvédère",
                "rue georges clémenceau",
                "rue de la fonderie",
                "chemin vert",
                "avenue léo lagrange",
                "résidence les carmes",
                "cité le calloy",
                "rue du terne",
                "rue de verdun",
                "chemin de Laudrissart"
            ],
            "jeudi": [
                "rue Roger salengro",
                "rue du Canada", 
                "Rue chartiaux", "rue augustin dimanche",
                "chemin des jardins", 
                "rue des haies",
                "chemin des haies",
                "impasse des jardins", 
                "impasse les carmes"
            ],
        },
        "verre": {
            "mercredi": [
                "2025-01-15",
                "2025-02-12",
                "2025-03-12",
                "2025-04-16",
                "2025-05-14",
                "2025-06-11",
                "2025-07-16",
                "2025-08-13",
                "2025-09-10",
                "2025-10-15",
                "2025-11-12",
                "2025-12-10"
            ],  
            "jeudi": [
                "2025-01-16",
                "2025-02-13",
                "2025-03-13",
                "2025-04-17",
                "2025-05-15",
                "2025-06-12",
                "2025-07-17",
                "2025-08-14",
                "2025-09-11",
                "2025-10-16",
                "2025-11-13",
                "2025-12-11"
            ]
        }
    }
};

function capitalizeEachWord(str) {
    return str.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

window.handleCityChange = function handleCityChange() {
    const city = document.getElementById("citySelect").value;
    const resultDiv = document.getElementById("result");
    const searchSection = document.getElementById("search-section");
    const searchInput = document.getElementById("search");
    const suggestionsDiv = document.getElementById("suggestions");

    // Réinitialiser l'interface
    resultDiv.style.display = 'none';
    searchSection.style.display = 'none';
    searchInput.value = '';
    suggestionsDiv.innerHTML = '';

    if (city === "") return;

    // Si la ville a un jour fixe
    if (typeof cityData[city].ordures === "string") {
        const jourCollecte = cityData[city].ordures;
        let message = `
  <div class="bg-white rounded-xl shadow-md p-6 mt-6 transition-all animate-fadeIn">
    <div class="flex items-center gap-2 text-lg font-semibold text-primary mb-4">
      <span>${city}</span>
    </div>
    <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4 flex items-start gap-3">
      <div>
        <span class="font-bold">La collecte des ordures ménagères et déchets recyclables a lieu les</span> ${jourCollecte}s.
      </div>
    </div>
`;
        
        // Ajouter les informations de collecte du verre si disponibles
        if (cityData[city].verre) {
            const jourVerre = cityData[city].verre.jour || jourCollecte;
            const prochaineDates = formatDatesVerre(cityData[city].verre, jourVerre);
            if (prochaineDates) {
                message += `
    <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-4 flex items-start gap-3">
      <div>
        <div class="font-bold mb-1">La collecte du verre a lieu les :</div>
        <ul class="list-disc pl-5 space-y-1 text-gray-700">${prochaineDates.split('<br>').map(date => `<li>${date}</li>`).join('')}</ul>
      </div>
    </div>
  </div>
`;
            }
        }
        
        resultDiv.innerHTML = message;
        resultDiv.className = '';
        resultDiv.style.display = 'block';
    } 
    // Si la ville a des rues spécifiques (Fourmies)
    else {
        searchSection.style.display = 'block';
    }
}

function formatDatesVerre(verreInfo, jour) {
    if (!verreInfo) return '';
    
    const currentDate = new Date();
    let datesToUse;
    
    // Pour les villes avec un seul jour de collecte
    if (verreInfo.dates && Array.isArray(verreInfo.dates)) {
        datesToUse = verreInfo.dates;
    } 
    // Pour les villes avec plusieurs jours de collecte (Fourmies)
    else if (verreInfo[jour.toLowerCase()]) {
        datesToUse = verreInfo[jour.toLowerCase()];
    }
    
    if (!datesToUse || !Array.isArray(datesToUse)) return '';
    
    const futureDates = datesToUse.filter(date => new Date(date) >= currentDate);
    
    if (futureDates.length === 0) return 'Prochaines dates à venir';
    
    return futureDates.slice(0, 12).map(date => {
        const dateObj = new Date(date);
        const jour = dateObj.toLocaleDateString('fr-FR', { weekday: 'long' });
        const jourMajuscule = jour.charAt(0).toUpperCase() + jour.slice(1);
        const numero = dateObj.getDate();
        const numeroFormate = numero === 1 ? "1er" : numero;
        const mois = dateObj.toLocaleDateString('fr-FR', { month: 'long' });
        const moisMajuscule = mois.charAt(0).toUpperCase() + mois.slice(1);
        const annee = dateObj.getFullYear();
        return `${jourMajuscule} ${numeroFormate} ${moisMajuscule} ${annee}`;
    }).join('<br> ');
}

window.searchStreet = function searchStreet() {
    const searchInput = document.getElementById('search');
    const suggestionsDiv = document.getElementById('suggestions');
    const resultDiv = document.getElementById('result');
    const selectedCity = document.getElementById('citySelect').value;
    
    if (!selectedCity) {
        alert('Veuillez sélectionner une ville');
        return;
    }

    const cityInfo = cityData[selectedCity];
    let searchText = searchInput.value.toLowerCase();
    suggestionsDiv.innerHTML = '';
    
    if (searchText.length < 2) {
        resultDiv.style.display = 'none';
        return;
    }

    let foundStreets = [];
    
    // Pour les villes avec des jours différents selon les rues
    const streets = Object.entries(cityInfo.ordures).flatMap(([day, streets]) => 
        streets.map(street => ({street: street, day: day}))
    );
    
    foundStreets = streets.filter(item => 
        item.street.toLowerCase().includes(searchText)
    );

    foundStreets.forEach(street => {
        const div = document.createElement('div');
        div.textContent = street.street;
        div.onclick = () => {
            let message = `
  <div class="bg-white rounded-xl shadow-md p-6 mt-6 transition-all animate-fadeIn">
    <div class="flex items-center gap-2 text-lg font-semibold text-primary mb-4">
      <span>${selectedCity}</span>
      <span class="text-gray-500">-</span>
      <span>${street.street}</span>
    </div>
    <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4 flex items-start gap-3">
      <div>
        <span class="font-bold">La collecte des ordures ménagères et déchets recyclables a lieu les</span> ${street.day}s.
      </div>
    </div>
`;
            
            // Ajouter les informations de collecte du verre si disponibles
            if (cityInfo.verre) {
                const prochaineDates = formatDatesVerre(cityInfo.verre, street.day);
                if (prochaineDates) {
                    message += `
    <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-4 flex items-start gap-3">
      <div>
        <div class="font-bold mb-1">La collecte du verre a lieu les :</div>
        <ul class="list-disc pl-5 space-y-1 text-gray-700">${prochaineDates.split('<br>').map(date => `<li>${date}</li>`).join('')}</ul>
      </div>
    </div>
  </div>
`;
                }
            }
            
            resultDiv.innerHTML = message;
            resultDiv.className = '';
            resultDiv.style.display = 'block';
            searchInput.value = street.street;
            suggestionsDiv.innerHTML = '';
        };
        suggestionsDiv.appendChild(div);
    });
}

window.clearSearch = function clearSearch() {
    document.getElementById('search').value = '';
    document.getElementById('suggestions').innerHTML = '';
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';
    resultDiv.style.display = 'none';
}

// Initialisation
document.addEventListener('DOMContentLoaded', (event) => {
    handleCityChange();
});