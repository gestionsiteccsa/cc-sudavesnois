# Application Home - Documentation

## üìã Vue d'ensemble

L'application **home** est l'application principale du projet CCSA. Elle g√®re la page d'accueil, les pages institutionnelles, les services publics et les fonctionnalit√©s transversales du site.

### R√¥le et Responsabilit√©s

- üè† **Page d'accueil** : Point d'entr√©e principal du site
- üìã **Pages institutionnelles** : Pr√©sentation, √©quipe, services
- üìß **Formulaire de contact** : Int√©gration avec l'app contact
- üîó **Navigation principale** : Liens vers toutes les sections
- üìú **Pages l√©gales** : Mentions l√©gales, RGPD, accessibilit√©
- üó∫Ô∏è **Sitemap XML** : G√©n√©ration automatique pour le SEO

## üèóÔ∏è Structure de l'Application

```mermaid
graph TD
    HOME[Application home/] --> VIEWS[views.py]
    HOME --> URLS[urls.py]
    HOME --> SITEMAP[sitemaps.py]
    HOME --> TEMPLATES[templates/home/]
    
    VIEWS --> PAGE_VIEWS[Pages Statiques]
    VIEWS --> SERVICE_VIEWS[Pages Services]
    VIEWS --> LEGAL_VIEWS[Pages L√©gales]
    VIEWS --> CONTACT_INTEGRATION[Int√©gration Contact]
    
    TEMPLATES --> INDEX[index.html]
    TEMPLATES --> PRESENTATION[presentation.html]
    TEMPLATES --> SERVICES[Services/*.html]
    TEMPLATES --> LEGAL[Pages l√©gales]
    
    SITEMAP --> STATIC_SITEMAP[StaticViewSitemap]
    SITEMAP --> COMMUNES_SITEMAP[CommunesSitemap]
    SITEMAP --> JOURNAL_SITEMAP[JournalSitemap]
    
    style HOME fill:#2ecc71,stroke:#27ae60,color:white
    style VIEWS fill:#3498db,stroke:#2980b9,color:white
    style TEMPLATES fill:#e74c3c,stroke:#c0392b,color:white
    style SITEMAP fill:#f39c12,stroke:#e67e22,color:white
```

## üìÅ Architecture des Fichiers

### Structure Compl√®te

```
home/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ apps.py                    # Configuration Django
‚îú‚îÄ‚îÄ views.py                   # 19 vues (206 lignes)
‚îú‚îÄ‚îÄ urls.py                    # 18 routes URL
‚îú‚îÄ‚îÄ sitemaps.py               # 3 sitemaps XML
‚îú‚îÄ‚îÄ models.py                 # Vide (pages statiques)
‚îú‚îÄ‚îÄ forms.py                  # Vide (utilise contact.forms)
‚îú‚îÄ‚îÄ tests.py                  # Vide (√† compl√©ter)
‚îú‚îÄ‚îÄ admin.py                  # Vide (pas de mod√®les)
‚îú‚îÄ‚îÄ templates/home/           # Templates sp√©cifiques
‚îÇ   ‚îú‚îÄ‚îÄ index.html           # Page d'accueil
‚îÇ   ‚îú‚îÄ‚îÄ presentation.html    # Pr√©sentation CCSA
‚îÇ   ‚îú‚îÄ‚îÄ equipe.html         # √âquipe administrative
‚îÇ   ‚îú‚îÄ‚îÄ collecte-dechets.html # Services d√©chets
‚îÇ   ‚îú‚îÄ‚îÄ maisons-sante.html   # Maisons de sant√©
‚îÇ   ‚îú‚îÄ‚îÄ mentions-legales.html # Mentions l√©gales
‚îÇ   ‚îú‚îÄ‚îÄ accessibilite.html   # Page accessibilit√©
‚îÇ   ‚îî‚îÄ‚îÄ [autres pages]...
‚îú‚îÄ‚îÄ management/              # Commandes Django personnalis√©es
‚îî‚îÄ‚îÄ migrations/              # Vide (pas de mod√®les)
```

## üîß Analyse des Vues

### Vue Principale - `home()`

```python
def home(request):
    """Page d'accueil avec int√©gration des services et formulaire de contact."""
    
    # R√©cup√©ration des donn√©es
    services = get_list_or_404(Service.objects.order_by('title')) if Service.objects.exists() else None
    communes = get_list_or_404(ConseilVille) if ConseilVille.objects.exists() else None
    
    # Calcul des statistiques
    if communes:
        nb_communes = len(communes)
        nb_habitants = sum(commune.nb_habitants for commune in communes)
    
    # Traitement du formulaire de contact
    if request.method == 'POST':
        contact_form = ContactForm(request.POST)
        if contact_form.is_valid():
            # Envoi d'emails (CCSA + confirmation client)
            # Redirection apr√®s succ√®s
    
    return render(request, 'home/index.html', context)
```

**Fonctionnalit√©s** :
- ‚úÖ Affichage des services disponibles
- ‚úÖ Statistiques des communes (nombre, habitants)
- ‚úÖ Int√©gration formulaire de contact
- ‚úÖ Envoi d'emails automatiques
- ‚úÖ Gestion des erreurs gracieuse

### Vues de Services

| Vue | URL | Description |
|-----|-----|-------------|
| `collecte_dechets` | `/collecte-dechets/` | Service de collecte des d√©chets |
| `encombrants` | `/encombrants/` | Collecte des encombrants |
| `dechetteries` | `/dechetteries/` | D√©chetteries du territoire |
| `maisons_sante` | `/maisons-sante-pluridisciplinaires/` | Maisons de sant√© |
| `mutuelle` | `/mutuelle-intercommunautaire/` | Mutuelle intercommunale |
| `mobilite` | `/mobilite/` | Services de mobilit√© |
| `habitat` | `/habitat/` | Aide √† l'habitat |
| `plui` | `/plui/` | Plan Local d'Urbanisme |

### Vues Institutionnelles

| Vue | URL | Description |
|-----|-----|-------------|
| `presentation` | `/presentation/` | Pr√©sentation de la CCSA |
| `equipe` | `/equipe/` | √âquipe administrative |
| `marches_publics` | `/marches-publics/` | March√©s publics |

### Vues L√©gales

| Vue | URL | Description |
|-----|-----|-------------|
| `mentions_legales` | `/mentions-legales/` | Mentions l√©gales |
| `politique_confidentialite` | `/politique-confidentialite/` | RGPD |
| `cookies` | `/politique-cookies/` | Gestion des cookies |
| `accessibilite` | `/accessibilite/` | D√©claration accessibilit√© |
| `plan_du_site` | `/plan-du-site/` | Plan du site |

## üó∫Ô∏è Gestion du Sitemap

### Classes de Sitemap (`sitemaps.py`)

```python
class StaticViewSitemap(Sitemap):
    """Sitemap pour les pages statiques."""
    priority = 0.8
    changefreq = 'monthly'
    
    def items(self):
        return ['home', 'presentation', 'equipe', ...]
    
    def location(self, item):
        return reverse(item)

class CommunesSitemap(Sitemap):
    """Sitemap pour les pages des communes."""
    
    def items(self):
        return ConseilVille.objects.all()
    
    def location(self, obj):
        return reverse('communes-membres:commune', args=[obj.slug])

class JournalSitemap(Sitemap):
    """Sitemap pour les publications du journal."""
    
    def items(self):
        return Journal.objects.filter(is_published=True)
```

### Configuration Sitemap

```mermaid
graph LR
    SITEMAP[sitemap.xml] --> STATIC[Pages Statiques]
    SITEMAP --> COMMUNES[12 Communes]
    SITEMAP --> JOURNAL[Publications Journal]
    
    STATIC --> HOME[Accueil]
    STATIC --> PRESENTATION[Pr√©sentation]
    STATIC --> SERVICES[Services]
    STATIC --> LEGAL[Pages l√©gales]
    
    COMMUNES --> ANOR[Anor]
    COMMUNES --> FOURMIES[Fourmies]
    COMMUNES --> TRELON[Tr√©lon]
    COMMUNES --> OTHERS[9 autres...]
    
    JOURNAL --> CURRENT[Journaux actuels]
    JOURNAL --> ARCHIVES[Archives]
    
    style SITEMAP fill:#2ecc71,stroke:#27ae60,color:white
    style STATIC fill:#3498db,stroke:#2980b9,color:white
    style COMMUNES fill:#e74c3c,stroke:#c0392b,color:white
    style JOURNAL fill:#f39c12,stroke:#e67e22,color:white
```

## üìß Int√©gration Email

### Syst√®me d'Email Contact

```python
# Configuration email dans la vue home()
if contact_form.is_valid():
    ccsa_contact = ContactEmail.objects.filter(is_active=True).values_list("email", flat=True)
    
    # Email vers CCSA
    context = {
        'first_name': contact_form.cleaned_data['first_name'],
        'last_name': contact_form.cleaned_data['last_name'],
        'email': contact_form.cleaned_data['email'],
        'message': contact_form.cleaned_data['message'],
    }
    
    msg = EmailMultiAlternatives(
        subject=f"CONTACT - CCSA : {first_name} {last_name}",
        body=render_to_string("email_text.txt", context),
        from_email=contact_form.cleaned_data['email'],
        to=ccsa_contact
    )
    msg.attach_alternative(render_to_string("email_html.html", context), "text/html")
    msg.send()
    
    # Email de confirmation au client
    msg_client = EmailMultiAlternatives(
        subject=f"CONFIRMATION DE CONTACT - CCSA",
        body=render_to_string("email_text_client.txt", context),
        from_email=ccsa_contact[0],
        to=[contact_form.cleaned_data['email']]
    )
    msg_client.send()
```

### Templates Email

| Template | Usage |
|----------|-------|
| `email_text.txt` | Version texte pour CCSA |
| `email_html.html` | Version HTML pour CCSA |
| `email_text_client.txt` | Confirmation texte client |
| `email_html_client.html` | Confirmation HTML client |

## üé® Templates et Frontend

### Template Principal - `index.html`

```html
{% extends "base.html" %}
{% load static %}

{% block title %}Accueil - Communaut√© de Communes Sud-Avesnois{% endblock %}

{% block meta_description %}
D√©couvrez la Communaut√© de Communes Sud-Avesnois : 
{{ nb_communes }} communes, {{ nb_habitants }} habitants. 
Services publics, √©lus, actualit√©s.
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section bg-gradient-to-r from-primary to-secondary">
    <div class="container mx-auto px-4 py-16">
        <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">
            Communaut√© de Communes Sud-Avesnois
        </h1>
        <p class="text-xl text-white/90 mb-8">
            {{ nb_communes }} communes ‚Ä¢ {{ nb_habitants }} habitants
        </p>
    </div>
</section>

<!-- Services Section -->
{% if services %}
<section class="services-section py-16">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-12">Nos Services</h2>
        <div class="grid md:grid-cols-3 gap-8">
            {% for service in services %}
            <div class="service-card bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4">{{ service.title }}</h3>
                <p class="text-gray-600 mb-4">{{ service.description|truncatewords:20 }}</p>
                <a href="{{ service.get_absolute_url }}" class="btn-primary">
                    En savoir plus
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Contact Form Section -->
<section class="contact-section bg-gray-50 py-16">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-12">Nous Contacter</h2>
        <div class="max-w-2xl mx-auto">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                {{ contact_form|crispy }}
                <button type="submit" class="btn-primary w-full">
                    Envoyer le message
                </button>
            </form>
        </div>
    </div>
</section>
{% endblock %}
```

### Composants R√©utilisables

| Composant | Description | Utilisation |
|-----------|-------------|-------------|
| Hero Section | Banni√®re principale | Page d'accueil |
| Service Cards | Cartes de services | Affichage services |
| Contact Form | Formulaire int√©gr√© | Contact direct |
| Stats Display | Affichage statistiques | Communes/habitants |

## üîç Int√©grations avec Autres Apps

### D√©pendances Externes

```python
# Imports dans views.py
from conseil_communautaire.models import ConseilVille  # Donn√©es communes
from contact.forms import ContactForm                   # Formulaire contact
from contact.models import ContactEmail                 # Emails destinataires
from services.models import Service                     # Services disponibles
```

### Flux de Donn√©es

```mermaid
graph TD
    HOME[home/views.py] --> CONSEIL[conseil_communautaire.models]
    HOME --> CONTACT[contact.forms]
    HOME --> SERVICES[services.models]
    
    CONSEIL --> COMMUNES[Donn√©es 12 communes]
    CONTACT --> FORM[Formulaire contact]
    SERVICES --> SERVICE_LIST[Liste services]
    
    COMMUNES --> STATS[Calcul statistiques]
    FORM --> EMAIL[Envoi emails]
    SERVICE_LIST --> DISPLAY[Affichage accueil]
    
    STATS --> TEMPLATE[Templates]
    EMAIL --> TEMPLATE
    DISPLAY --> TEMPLATE
    
    style HOME fill:#2ecc71,stroke:#27ae60,color:white
    style TEMPLATE fill:#e74c3c,stroke:#c0392b,color:white
```

## üîß Fonctions Utilitaires

### `is_staff_or_superuser(user)`

```python
def is_staff_or_superuser(user):
    """V√©rifier si l'utilisateur est staff ou superuser.
    
    Args:
        user: L'utilisateur √† v√©rifier.
        
    Returns:
        bool: True si l'utilisateur est staff ou superuser.
    """
    return user.is_staff or user.is_superuser
```

### `custom_handler404(request, exception=None)`

```python
def custom_handler404(request, exception=None):
    """Gestionnaire personnalis√© pour les erreurs 404."""
    return render(request, '404.html', status=404)
```

## üß™ Tests √† Impl√©menter

### Tests Manquants

Le fichier `tests.py` est actuellement vide. Voici les tests recommand√©s :

```python
# Tests sugg√©r√©s pour home/tests.py
class HomeViewsTestCase(TestCase):
    def test_home_view_get(self):
        """Test affichage page d'accueil"""
        
    def test_home_view_contact_form_valid(self):
        """Test soumission formulaire contact valide"""
        
    def test_home_view_contact_form_invalid(self):
        """Test soumission formulaire contact invalide"""
        
    def test_presentation_view(self):
        """Test page pr√©sentation"""
        
    def test_all_static_pages(self):
        """Test toutes les pages statiques"""
        
class SitemapTestCase(TestCase):
    def test_static_sitemap(self):
        """Test g√©n√©ration sitemap statique"""
        
    def test_communes_sitemap(self):
        """Test sitemap communes"""
        
    def test_journal_sitemap(self):
        """Test sitemap journal"""
```

## üìä M√©triques de l'Application

| M√©trique | Valeur | √âvaluation |
|----------|--------|------------|
| **Vues** | 19 vues | ‚úÖ Bien organis√© |
| **URLs** | 18 routes | ‚úÖ URL SEO-friendly |
| **Templates** | 15+ templates | ‚úÖ Modulaires |
| **Lignes de code** | 206 lignes | ‚úÖ Concis |
| **D√©pendances** | 4 apps | ‚úÖ Couplage ma√Ætris√© |
| **Tests** | 0 tests | ‚ùå √Ä impl√©menter |

## üöÄ Optimisations et Am√©liorations

### Court Terme
- ‚úÖ Ajouter des tests unitaires complets
- ‚úÖ Optimiser les requ√™tes dans la vue `home()`
- ‚úÖ Ajouter la gestion d'erreurs pour les emails
- ‚úÖ Impl√©menter la pagination pour les services

### Moyen Terme
- üìà Cache des donn√©es fr√©quemment consult√©es
- üìà Lazy loading des images sur la page d'accueil
- üìà Optimisation SEO avanc√©e avec donn√©es structur√©es
- üìà A/B testing sur le formulaire de contact

### Long Terme
- üöÄ API REST pour les donn√©es d'accueil
- üöÄ PWA (Progressive Web App) capabilities
- üöÄ Analytics avanc√©es pour les interactions
- üöÄ Personnalisation du contenu selon l'utilisateur

## üîê S√©curit√©

### Mesures Implement√©es
- ‚úÖ Protection CSRF sur tous les formulaires
- ‚úÖ Validation stricte des donn√©es du formulaire
- ‚úÖ Sanitisation des emails envoy√©s
- ‚úÖ Gestion des erreurs sans exposition d'informations

### √Ä Renforcer
- ‚ö†Ô∏è Rate limiting sur le formulaire de contact
- ‚ö†Ô∏è Validation c√¥t√© serveur plus stricte
- ‚ö†Ô∏è Logs de s√©curit√© pour les tentatives malveillantes

---

*Documentation application home - Derni√®re mise √† jour : 07/01/2025*